---
resource_types:
- name: k8s
  type: docker-image
  source:
    repository: kudohn/concourse-k8s-resource
    tag: 0.0.3

resources:
- name: k8s
  type: k8s
  source:
#    api_server_url: https://172.16.10.11:6443
#    api_server_cert: |
#      -----BEGIN CERTIFICATE-----
#      .....
#      -----END CERTIFICATE-----
#
#    client_cert: |
#      -----BEGIN CERTIFICATE-----
#      .....
#      -----END CERTIFICATE-----
#
#    client_key: |
#      -----BEGIN PRIVATE KEY-----
#      .....
#      -----END PRIVATE KEY-----

    kubeconfig: |
      apiVersion: v1
      kind: Config
      clusters:
        - cluster:
            certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN5RENDQWJDZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRFNU1USXpNVEl6TlRrMU9Gb1hEVEk1TVRJeU9ESXpOVGsxT0Zvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBSnNoCml1R3J2ZEkxWXp1UU05eXJSRXNSdWdTK0pXQkxZdmxvNGcrTEtkdDJZVkhoR1Q2dHlkNCtGWnhvZHE5NWtrbjcKOERFcGF1OExMQ012WEdUVVBHU2RXZ2JINzBKa3RzOG1TWHdvWTFSK0dGekxvbEtlRWRnT2NDbjVIVkFoMEwvVgp2Wmw2MEl5K0dJKzNuL3EwQythU0UrSVFHZWJxcjkvcmlwcGhKdnVmRXc4V2hkeTNwUXBsaGFacThyQkxORHI1CnU5Tk9SK0lRT3Z2ZjI1bkFiQXZQK2xIOUNGY2NrYjZudjJmVi9ROFl5YkFBOC9iRmFORG8rbVhRYkd0Sjlna0sKSkJuU1dEMm41TE5YNEczeXcycC8zOFVRVFRDRjR0U0kvOTJVRWlvYmJPcUFQMzdtRVFRT2tjeFFYaGFkdE1KegpRV3U4WEdlNDgzQ3RGME5rdTBFQ0F3RUFBYU1qTUNFd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFBQUovZ3JGdmtyNTJBVmdGN1ZFMWN2azQxMjgKakZsKzNvd0I5aWQrWEZxZVVmSklzMmtRcUcxSWtTUWhXNFhScDJvWitkd0owTWY5ODUyb0NSdFhOYUpCaEZjSApuMUxXbVRzcVkvdjNhYnJ5ZzNQZXpIRG94em5DVzJWMHpIYWVDLzQ2b01XZG9ZVjBHcnV5azVWSXVVMHBzbU9JCksvTzFPNEJWaG1tVlhWRWZwSHJpR2dkY0ErMEhiczN4SUlGV2x1UTFCSFdwcS9FSEEyUVBzTDNCZlVzcHRFbTQKaU5FL1ZhcTdnT3BISFNsSGQxMS9sQ3pDYitVd2xlZ3RqbzY2d2lTb1RHUk1wL01PRDdvODFkU1czamhLdHQrcAphZWlObDEyRnlnRkUvWW9zWDNuUkdYMVVvV2VDL1RtWS9wNnEramVLb0VYUkEvUlhBVW1aWUZYaFEyUT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
            server: https://172.16.10.11:6443
          name: local-k8s
      contexts:
        - context:
            cluster: local-k8s
            namespace: default
            user: admin
          name: local-k8s-tester
      current-context: local-k8s-tester
      preferences: {}
      users:
        - name: admin
          user:
            client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN3akNDQWFvQ0ZEdlhEUlB5RHFPR3BoTFBoQldUU0lGNHN2YkdNQTBHQ1NxR1NJYjNEUUVCQ3dVQU1CVXgKRXpBUkJnTlZCQU1UQ210MVltVnlibVYwWlhNd0hoY05NakF3TVRBeE1EQXdNREl6V2hjTk1qQXhNakkyTURBdwpNREl6V2pBbU1RNHdEQVlEVlFRRERBVmhaRzFwYmpFVU1CSUdBMVVFQ2d3TGJXRnRaWHB2ZFMxemNtVXdnZ0VpCk1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLQW9JQkFRQ3JOc0U2dWYvbVl2aUVSOTNPN2RtSFZFamUKN2xtTVNJOG1CaUZyR3JidjBwbkt5OHNiVEVSYzZMQjJzT05nb296ZUpBWGJPalhuK04rUzVFWWFub3pGQmlnVwpvdm1CZXA2TncvbWt1RFJ4dTNlRGVETmtSL09yRmRVTTUrZXJBMWQrTmJkc2dsbklmUmFrQ285MCtoTHI3c3VLCmtQZEpQNFU1ZUo1bG5rcXhZNzNoT29XZEhNRWNXQ3lDZnFiUStYN0VRMTcrclVFcnhNUG9lM2thc05QdEFFa2IKb2tTeHpmSGQ1bzFicy82UG4zV3dxU0szc3NiaC90SEh3UDYyckNnNERnTmJSZU5sRzI5VXJsSVh0VzIxb0FsYgpIK1Zzb1pPUmYwR3R2N3djbXF0RTJ3R2N6MjEwRU5oQ3FUWngwU2d0UUNvRk1NNjBNdlYrdTJaSjhpMERBZ01CCkFBRXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBSlg5L1hhNFZBVEgxS1U4M09QUkx4UWJCK00wZXI4NlZqd0UKVUdMNHdIRW1hMVhZREdEZHdCVFNGUVh4YTZkbXZZdFdaSjZiT1dhMFMrSW84V1VtQVErRkUrTFA3dW9oY3p0MQpadHVsNlpFMnZJWEV0MWNUaFJIalZwZzFnSmVQcUhpS2F6RWNsRGJkaHFuTFNzZDA0TmRMMnZHOUtaTlM5RHdrCktCamEzcm16SmV5UzFoQU8zcHUzczdiTnVsb2tBeVI1YTlWR1pzSzl4TER5L0s5TTZwQXBGWHpSaVZ1N2dOUEwKY2dCV1hoOTh2S0FqNEYyalc1TjJyOTJvSFRSeFk5dlg3QWNGVjMyUlFkWUQyY1ArUVdnSVN0MmlxQkJiZ2NXdwo3c0EvTWoySkN1cUNJWVY2OTlDRG8wRXUxYWNaWjV5Z0puMnlGZ0tRci8wTEpSLy9NOXc9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
            client-key-data: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2QUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktZd2dnU2lBZ0VBQW9JQkFRQ3JOc0U2dWYvbVl2aUUKUjkzTzdkbUhWRWplN2xtTVNJOG1CaUZyR3JidjBwbkt5OHNiVEVSYzZMQjJzT05nb296ZUpBWGJPalhuK04rUwo1RVlhbm96RkJpZ1dvdm1CZXA2TncvbWt1RFJ4dTNlRGVETmtSL09yRmRVTTUrZXJBMWQrTmJkc2dsbklmUmFrCkNvOTAraExyN3N1S2tQZEpQNFU1ZUo1bG5rcXhZNzNoT29XZEhNRWNXQ3lDZnFiUStYN0VRMTcrclVFcnhNUG8KZTNrYXNOUHRBRWtib2tTeHpmSGQ1bzFicy82UG4zV3dxU0szc3NiaC90SEh3UDYyckNnNERnTmJSZU5sRzI5VQpybElYdFcyMW9BbGJIK1Zzb1pPUmYwR3R2N3djbXF0RTJ3R2N6MjEwRU5oQ3FUWngwU2d0UUNvRk1NNjBNdlYrCnUyWko4aTBEQWdNQkFBRUNnZ0VBUXgzODA2TzBjRUVlQU9VWFM1WXI3d1FZYU9QdzBMQmxCVmZqNDlPZUlSZGkKMkgvWlNBTTJ6V0VlUS9rRnVZMGZRYm5IWGZCTXozbmRVdjBQaWtIYkZ5VlpzNzRCcDBORlFuZXZ0bVhMa1VZWApETCtqRGMyeTlMOWpQR0x3aXphTkp0bXg1T1NZZzZLZHJJTERSK3o4VytiSmZiRmtieDlxZjJRTVcvT1lmajdpClBBWGJkeEY3L2VSUmsrcnN1MHRyWi9zRFFYTUg4QTNpVHBHcG94azN6RXpsR3N3Q3Z2UXJKV2l1cHBoREZvTXQKZ093TGdGL2t6alN5Qkpac2xMSi8raFdhdlNXM1VpSk1OTlRja3k3eXZxaitwMzVYMkZsZ29wM0xFVWpaZHExOQp0amRqU0ZyREhyMytvZEZjeGl4SDNka0RXSW5KWTV4aGdaYmxSUkVyV1FLQmdRRFM1M09MSzN6dHJqenFNak1kClhQMm42RElZRVEwL2NPaTg5VUx0MzIyVFJQS2JGdG5JNG1UcUNFSDRDYVJTOXNaV0NzSnMyT1gxSkwrbU9iWk8Kd2ZqMUcxVGpYVHJHTFpWUG5PWGFlOUlJU0pmRnJ0aFNRbTMyZEZRNStmYWhpVlBVUEl5dVVobUxWYUdGbzZvUwpQVmhOWE9ZaGtkcm9xUDdpRG9vWjFBVWJ2d0tCZ1FEUDBybWtEVHRRQmdEZ3pFVDBMbldaZHNEaFo0eDdkMkdSCm4yT2c3ODFwbUlNQ05tVkg1U1RVLzkxU0xTeFhjRC95clVvYVZzZVdDbHVPbHdrTkxGeUFTRFBwQjd3Q3VQcEIKOXdIMWMzOGlJUWozL0xRbnp6NGk4RFFoZ29Cbm5iMXZPLzNCdTFtQnhDODhud1JCMzhoWGY5Yk91dTRDTmF5OApZTVg3UjVPUHZRS0JnQnlCZ0JKOWJFTkwyNXZqOFJpMDZ1djQ3RnhvWVp3RGpOR05iT0J0NUllVk9CMVNOMWw1CmtCNDV3NERjL01MaDYralJSM29penVJVmQzbm1Md2Z5Rzg0MVJZSDlwZVlIWHprRmdlUEgvSmwyQmwySHhtRkgKN1VqMGJEWHgzUzMwTzhwaDdMbmJDdXpVUkNLbC9tUzh1ZVNxKzhmcHlPYk5nTFhaTlQxTWRPeE5Bb0dBTzV0WQpEWHFTRVlDM1RjS280RlJXL0g0NEVpNXQ5NWVsRDJ4azJlc053b1N3eHJpdFVmS2lIc21JUkNLYXZqViswZTdyCit5UDZ1TWtkdTRjTVhJL2x0QkdCZWd2eTIrRU1QbEZIYVl3SDRkVVJ5bmJiZ1RPS3dlQ2RReU00Q3dBT0xsSkoKbFFCVVNzam5OMzd3YktodndORDAzblIxQVlNOW1RWTBvcjdEencwQ2dZQUlMMis4TEkzdTJ6UHpuMnRQaW1ONQp1RkxVMWkrazhUbHRxRnM3NXpKeFcvL1RPemFYNnl4Tktjckd3bWltV050RWdTc0orSmljSGFJUVR6a0ViSmxpCnZlZkd5Sm5lLzQ1MXhFSFc0amhoRWl3YTRyTXc0ZkN3Tloxclg3bDkrWVpacUhRVHM3eFJWOGRJRDNmY2ZBbnEKWGt2MFdDd252QUgwUENRUDRJdHFCdz09Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K

    # client_token: .....

    skip_tls_verify: false
    namespace: dev
    #debug: true
    watch_resources:
    - name: app1
      kind: Deployment
    - name: app2
      kind: Deployment
    - name: web
      kind: StatefulSet

- name: repo
  type: git
  source:
    uri: https://github.com/mamezou-tech/concourse-k8s-resource.git
    branch: master
    paths: [test]

jobs:
- name: deploy-plain
  plan:
  - get: repo
  - put: k8s
    params: &plain-param
      status_check_timeout: 60 # sec
      paths:
        - repo/test/plain/deploy1.yaml
        - repo/test/plain/deploy2.yaml
        - repo/test/plain/sts.yaml
        # or
        # - repo/test/plain

- name: deploy-kustomize
  plan:
  - get: repo
  - put: k8s
    params: &kustomize-param
      kustomize: true
      status_check_timeout: 60 # sec
      command_timeout: 30 # sec
      paths:
      - repo/test/kustomize/overlays/prod

- name: e2e-test-plain
  plan:
  - get: k8s
    trigger: true
    passed: [deploy-plain]
  - task: e2e-test
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: busybox
          tag: latest
      inputs:
      - name: k8s
      run:
        path: sh
        args:
        - -c
        - |
          cat k8s/version
          exit 1
    on_failure:
      # if test failed, rollback resources
      put: k8s
      params:
        undo: true

- name: e2e-test-kustomize
  plan:
  - get: k8s
    trigger: true
    passed: [deploy-kustomize]
  - task: e2e-test
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: busybox
          tag: latest
      inputs:
        - name: k8s
      run:
        path: sh
        args:
          - -c
          - |
            cat k8s/version
            exit 1
    on_failure:
      # if test failed, rollback resources
      put: k8s
      params:
        undo: true

- name: delete-plain
  plan:
  - get: repo
  - put: k8s
    params:
      <<: *plain-param
      delete: true

- name: delete-kustomize
  plan:
  - get: repo
  - put: k8s
    params:
      <<: *kustomize-param
      delete: true
